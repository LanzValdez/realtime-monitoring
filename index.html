<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Real-Time Monitoring</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <style>
    body {
      background-color: #f8f9fa;
    }

    .log-box {
      background: #111;
      color: #0f0;
      padding: 10px;
      border-radius: 8px;
      font-family: monospace;
      height: 150px;
      overflow-y: auto;
      font-size: 0.9rem;
    }

    .status-passed {
      color: #198754; /* green */
      font-weight: bold;
    }

    .status-failed {
      color: #dc3545; /* red */
      font-weight: bold;
    }

    .status-running {
      color: #ffc107; /* yellow */
      font-weight: bold;
    }

    .table td, .table th {
      vertical-align: middle;
    }
  </style>
</head>

<body class="p-4">
  <div class="container">
    <h2 class="mb-4">üß† Real-Time Monitoring</h2>

    <div class="d-flex justify-content-end mb-3">
      <button id="runBtn" class="btn btn-primary">
        ‚ñ∂ Run Playwright Test
      </button>
    </div>

    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th scope="col" style="width: 25%">Process</th>
          <th scope="col" style="width: 15%">Status</th>
          <th scope="col" style="width: 20%">Last Run Time</th>
          <th scope="col">Logs</th>
        </tr>
      </thead>
      <tbody id="monitorTable">
        <tr id="ninjaAI">
          <td>Ninja AI Quicktype</td>
          <td class="status">Idle</td>
          <td class="last-run">‚Äî</td>
          <td>
            <div class="log-box" id="ninjaLogs"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    const runBtn = document.getElementById("runBtn");
    const logsBox = document.getElementById("ninjaLogs");
    const statusCell = document.querySelector("#ninjaAI .status");
    const timeCell = document.querySelector("#ninjaAI .last-run");

    // Append log message
    function addLog(msg) {
      const div = document.createElement("div");
      div.textContent = msg;
      logsBox.appendChild(div);
      logsBox.scrollTop = logsBox.scrollHeight;
    }

    // Listen to live server events
    const eventSource = new EventSource("http://192.168.100.100:4000/events");
    eventSource.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);

        if (data.type === "log") {
          addLog(data.message);
        } else if (data.type === "status") {
          const { state, time } = data.message;
          timeCell.textContent = time;

          if (state === "running") {
            statusCell.textContent = "Running...";
            statusCell.className = "status status-running";
          } else if (state === "passed") {
            statusCell.textContent = "Passed";
            statusCell.className = "status status-passed";
          } else if (state === "failed") {
            statusCell.textContent = "Failed";
            statusCell.className = "status status-failed";
          }
        }
      } catch (err) {
        console.error("Invalid event data:", event.data);
      }
    };

    // Run Playwright test
    runBtn.addEventListener("click", async () => {
      logsBox.innerHTML = ""; // Clear previous logs
      addLog("‚ñ∂ Starting Playwright test...");

      try {
        const res = await fetch("http://192.168.100.100:4000/run-playwright", {
          method: "POST",
        });
        const data = await res.json();

        if (data.success) {
          addLog("‚úÖ Playwright test completed successfully!");
        } else {
          addLog("‚ùå Test failed: " + (data.error || "Unknown error"));
        }
      } catch (err) {
        addLog("‚ùå Connection error: " + err.message);
      }
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
